name: Build and Release start-cli

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      start_os_branch:
        description: "What Start9Labs/start-os branch to build from"
        required: true
        type: string
        default: "next/major"

permissions:
  contents: write
  actions: read

env:
  CARGO_TERM_COLOR: always
  UPSTREAM_REPO: Start9Labs/start-os
  UPSTREAM_REF: ${{ github.event.inputs.start_os_branch || 'next/major' }}
  NODEJS_VERSION: "24.11.0"

jobs:
  prepare:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      tag_name: ${{ steps.set.outputs.tag_name }}
      should_release: ${{ steps.set.outputs.should_release }}
    steps:
      - id: set
        name: Determine release parameters
        shell: bash
        run: |
          TAG=""
          SHOULD_RELEASE=false

          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "ğŸ“¦ Manual release triggered for branch: ${{ env.UPSTREAM_REF }}"
            CARGO_URL="https://raw.githubusercontent.com/${{ env.UPSTREAM_REPO }}/${{ env.UPSTREAM_REF }}/core/startos/Cargo.toml"
            echo "Fetching Cargo.toml from $CARGO_URL"
            for i in {1..3}; do
              echo "Attempt $i of 3..."
              if TAG=$(curl -fsL "$CARGO_URL" | grep -m 1 'version = ' | sed 's/version = "\(.*\)".*/\1/'); then
                break
              fi
              if [[ $i -lt 3 ]]; then
                echo "Failed, waiting 5 seconds before retry..."
                sleep 5
              else
                echo "âŒ Failed to fetch Cargo.toml after 3 attempts"
                exit 1
              fi
            done
            if [[ ! $TAG == v* ]]; then
              TAG="v$TAG"
            fi
            SHOULD_RELEASE=true
            echo "Version from Cargo.toml: $TAG"
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            TAG="${{ github.ref_name }}"
            SHOULD_RELEASE=true
            echo "ğŸ·ï¸ Tag push detected: $TAG"
          else
            echo "âš ï¸ No release will be created (no tag or manual input)"
          fi

          echo "tag_name=$TAG" >> "$GITHUB_OUTPUT"
          echo "should_release=$SHOULD_RELEASE" >> "$GITHUB_OUTPUT"

  compile:
    name: Build ${{ matrix.triple }}
    needs: prepare
    strategy:
      fail-fast: false
      matrix:
        include:
          - triple: "x86_64-unknown-linux-musl"
            runner: "ubuntu-latest"
            platform: "x86_64"
          - triple: "x86_64-apple-darwin"
            runner: "ubuntu-latest"
            platform: "x86_64"
          - triple: "aarch64-unknown-linux-musl"
            runner: "ubuntu-22.04-arm"
            platform: "aarch64"
          - triple: "aarch64-apple-darwin"
            runner: "ubuntu-22.04-arm"
            platform: "aarch64"
          - triple: "riscv64gc-unknown-linux-musl"
            runner: "ubuntu-22.04-arm"
            platform: "riscv64"
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Cleaning up unnecessary files
        run: |
          sudo apt-get remove --purge -y mono-* \
            ghc* cabal-install* \
            dotnet* \
            php* \
            ruby* \
            mysql-* \
            postgresql-* \
            azure-cli \
            powershell \
            google-cloud-sdk \
            msodbcsql* mssql-tools* \
            imagemagick* \
            libgl1-mesa-dri \
            google-chrome-stable \
            firefox || true
          sudo apt-get autoremove -y || true
          sudo apt-get clean || true

      - uses: actions/checkout@v4
        with:
          repository: ${{ env.UPSTREAM_REPO }}
          ref: ${{ env.UPSTREAM_REF }}
          submodules: recursive

      - name: ğŸ” Show upstream commit
        run: |
          echo "Building from commit:"
          git rev-parse HEAD
          echo ""
          echo "Submodules:"
          git submodule status

      - name: ğŸ“ Generate GIT_HASH.txt (required by build)
        run: |
          git rev-parse HEAD > GIT_HASH.txt
          echo "GIT_HASH: $(cat GIT_HASH.txt)"

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODEJS_VERSION }}

      - name: Set up docker QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure sccache
        uses: actions/github-script@v7
        with:
          script: |
            core.exportVariable('ACTIONS_RESULTS_URL', process.env.ACTIONS_RESULTS_URL || '');
            core.exportVariable('ACTIONS_RUNTIME_TOKEN', process.env.ACTIONS_RUNTIME_TOKEN || '');

      - name: Make
        run: TARGET=${{ matrix.triple }} make cli
        env:
          PLATFORM: ${{ matrix.platform }}
          SCCACHE_GHA_ENABLED: on
          SCCACHE_GHA_VERSION: 0

      - name: ğŸ“¦ Package and verify binary
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p artifacts

          BIN="core/target/${{ matrix.triple }}/release/start-cli"

          if [[ ! -f "$BIN" ]]; then
            echo "âŒ Binary not found at: $BIN"
            exit 1
          fi

          if [[ "${{ matrix.triple }}" == *"musl"* ]]; then
            echo "ğŸ” Verifying musl binary is statically linked..."
            LDD_OUTPUT=$(ldd "$BIN" 2>&1 || true)
            echo "ldd output: $LDD_OUTPUT"
            if [[ "$LDD_OUTPUT" == *"not a dynamic executable"* ]] || [[ "$LDD_OUTPUT" == *"statically linked"* ]]; then
              echo "âœ… Binary is statically linked (musl)"
            else
              echo "âš ï¸ WARNING: Binary appears to be dynamically linked!"
              echo "$LDD_OUTPUT"
            fi
            echo "File command output:"
            file "$BIN"
          fi

          OUT="artifacts/start-cli-${{ matrix.triple }}"
          cp "$BIN" "$OUT"
          chmod +x "$OUT"

          echo "ğŸ“ Binary size before stripping: $(du -h "$OUT" | cut -f1)"
          (strip "$OUT" || llvm-strip "$OUT" || true) 2>/dev/null || true
          echo "ğŸ“ Binary size after stripping: $(du -h "$OUT" | cut -f1)"

          pushd artifacts >/dev/null
          tar -czf "start-cli-${{ matrix.triple }}.tar.gz" "start-cli-${{ matrix.triple }}"
          if command -v sha256sum >/dev/null 2>&1; then
            sha256sum "start-cli-${{ matrix.triple }}.tar.gz" > "start-cli-${{ matrix.triple }}.tar.gz.sha256"
          else
            shasum -a 256 "start-cli-${{ matrix.triple }}.tar.gz" > "start-cli-${{ matrix.triple }}.tar.gz.sha256"
          fi
          echo "ğŸ“¦ Archive created: start-cli-${{ matrix.triple }}.tar.gz"
          popd >/dev/null

      - uses: actions/upload-artifact@v4
        with:
          name: cli-binaries-${{ matrix.triple }}
          path: artifacts/

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [prepare, compile]
    if: needs.prepare.outputs.should_release == 'true'
    steps:
      - name: ğŸ“¥ Download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: cli-binaries-*
          path: release-binaries
          merge-multiple: true

      - name: ğŸ” Verify artifacts and create combined checksums
        working-directory: release-binaries
        run: |
          echo "ğŸ“¦ Downloaded binaries:"
          ls -lh *.tar.gz
          echo ""
          cat *.sha256 > sha256sums.txt
          echo "âœ… SHA256 checksums:"
          cat sha256sums.txt

      - name: ğŸ“ Generate release notes
        working-directory: release-binaries
        env:
          TAG_NAME: ${{ needs.prepare.outputs.tag_name }}
          UPSTREAM_REPO: ${{ env.UPSTREAM_REPO }}
          UPSTREAM_REF: ${{ env.UPSTREAM_REF }}
        run: |
          # Header + instructions
          cat > release-notes.txt << 'EOF'
          ## Start CLI VERSION_PLACEHOLDER

          ### ğŸ“¦ Installation

          Download the appropriate binary for your platform and extract:
          ```
          tar -xzf start-cli-<platform>.tar.gz
          chmod +x start-cli-<platform>
          sudo mv start-cli-<platform> /usr/local/bin/start-cli
          ```

          ### ğŸ” Verify Download

          Compare the checksum with the values below:
          ```
          shasum -a 256 start-cli-<platform>.tar.gz
          ```

          ### âœ… SHA256 Checksums
          ```
          EOF

          # Inject checksums
          cat sha256sums.txt >> release-notes.txt

          # Close checksum code fence and add build info
          cat >> release-notes.txt << 'EOF'
          ```

          ### ğŸ“‹ Build Information
          - Built from: `UPSTREAM_REPO_PLACEHOLDER` @ `UPSTREAM_REF_PLACEHOLDER`
          - Linux binaries: Static musl builds (no glibc dependency)
          - macOS binaries: Native builds for Intel and Apple Silicon
          EOF

          # Replace placeholders with real values
          sed -i "s/VERSION_PLACEHOLDER/$TAG_NAME/g" release-notes.txt
          sed -i "s|UPSTREAM_REPO_PLACEHOLDER|$UPSTREAM_REPO|g" release-notes.txt
          sed -i "s|UPSTREAM_REF_PLACEHOLDER|$UPSTREAM_REF|g" release-notes.txt

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-binaries/start-cli-*.tar.gz
            release-binaries/sha256sums.txt
          name: Start CLI ${{ needs.prepare.outputs.tag_name }}
          tag_name: ${{ needs.prepare.outputs.tag_name }}
          body_path: release-binaries/release-notes.txt
          draft: false
          prerelease: ${{ contains(needs.prepare.outputs.tag_name, 'alpha') || contains(needs.prepare.outputs.tag_name, 'beta') }}
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
